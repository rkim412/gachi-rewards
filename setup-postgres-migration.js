// Script to set up PostgreSQL migrations
import { readFileSync, writeFileSync, existsSync, mkdirSync } from 'fs';
import { join } from 'path';
import { execSync } from 'child_process';

console.log('üîÑ Setting up PostgreSQL migrations...\n');

try {
  // Step 1: Verify migration_lock.toml is updated
  const lockPath = join(process.cwd(), 'prisma', 'migrations', 'migration_lock.toml');
  if (existsSync(lockPath)) {
    const lockContent = readFileSync(lockPath, 'utf8');
    if (lockContent.includes('provider = "postgresql"')) {
      console.log('‚úÖ migration_lock.toml is set to postgresql');
    } else {
      console.log('‚ö†Ô∏è  migration_lock.toml needs to be updated');
      writeFileSync(lockPath, `# Please do not edit this file manually
# It should be added in your version-control system (e.g., Git)
provider = "postgresql"
`, 'utf8');
      console.log('‚úÖ Updated migration_lock.toml');
    }
  }

  // Step 2: Check if DATABASE_URL is set
  if (!process.env.DATABASE_URL) {
    console.error('‚ùå DATABASE_URL environment variable is not set!');
    console.error('   Make sure your .env file has DATABASE_URL set');
    process.exit(1);
  }

  if (!process.env.DATABASE_URL.startsWith('postgresql://') && !process.env.DATABASE_URL.startsWith('postgres://')) {
    console.error('‚ùå DATABASE_URL must start with postgresql:// or postgres://');
    console.error(`   Current value starts with: ${process.env.DATABASE_URL.substring(0, 20)}...`);
    process.exit(1);
  }

  console.log('‚úÖ DATABASE_URL is set correctly\n');

  // Step 3: Create a new migration for PostgreSQL
  console.log('üì¶ Creating new PostgreSQL migration...');
  console.log('   This will create a fresh migration compatible with PostgreSQL\n');

  try {
    // Use prisma migrate dev to create a new migration
    // This will detect the schema changes and create PostgreSQL-compatible SQL
    execSync('npx prisma migrate dev --name init_postgresql', {
      stdio: 'inherit',
      env: process.env
    });
    console.log('\n‚úÖ Migration created successfully!');
  } catch (error) {
    console.error('\n‚ùå Error creating migration:', error.message);
    console.log('\nüí° Alternative: You can manually run:');
    console.log('   npx prisma migrate dev --name init_postgresql');
    process.exit(1);
  }

} catch (error) {
  console.error('‚ùå Error:', error.message);
  process.exit(1);
}
