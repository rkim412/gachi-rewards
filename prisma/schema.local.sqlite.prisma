// Local Development Schema - SQLite
// Use this for quick local testing without PostgreSQL
// 
// To use: Temporarily rename this file to schema.prisma or
// create a symlink, or copy the datasource section below

generator client {
  provider = "prisma-client-js"
}

// SQLite for local development (no database server needed)
datasource db {
  provider = "sqlite"
  url      = "file:./dev.sqlite"
}

// ============================================================================
// SHOPIFY APP SESSION STORAGE
// ============================================================================
// Stores Shopify app authentication sessions
// Managed by @shopify/shopify-app-session-storage-prisma
model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)
}

// ============================================================================
// GACHI REWARDS - CORE MODELS
// ============================================================================

// StorefrontUser: Represents a customer who can refer others
// Links Shopify Customer IDs to referral codes
// ENHANCED: Includes direct relationship to referrals made
model StorefrontUser {
  id                Int @id @default(autoincrement())
  email             String  // Customer email (for lookups and self-referral prevention)
  shopifyCustomerId String  // Full Shopify GID: "gid://shopify/Customer/123456789"
  siteId            String  // Shop domain: "store.myshopify.com" (for multi-tenant isolation)
  
  // Relations
  referralCode ReferralCode?  // Their referral code (one-to-one)
  referralsMade ReferralJoin[] @relation("ReferrerToReferee")  // People they referred (one-to-many)
  
  createdAt         DateTime @default(now())
  
  // Multi-tenant unique constraint: Same customer can exist in multiple shops
  @@unique([shopifyCustomerId, siteId])
  
  // Indexes for performance
  @@index([email, siteId])        // Email lookup per shop
  @@index([siteId])               // Shop-specific queries
  @@index([shopifyCustomerId])     // Shopify customer ID lookups
}

// ReferralCode: The shareable referral code for a customer
// One per customer - this is what they share with friends (e.g., "ALICE123")
// Previously named: ReferralDiscountCode
model ReferralCode {
  id        Int @id @default(autoincrement())
  code      String  // Unique referral code: "ALICE123" (8 chars, uppercase)
  siteId    String  // Shop domain for multi-tenant isolation
  referrerId Int @unique  // Links to StorefrontUser who owns this code (one-to-one)
  referrer StorefrontUser @relation(fields:[referrerId], references:[id], onDelete: Cascade)
  
  // Related records
  referralJoins ReferralJoin[]      // All referrals made using this code
  discountCodes ReferralDiscountCode[]  // One-time discount codes generated from this referral code
  
  createdAt DateTime @default(now())
  
  // Unique constraint: Referral codes must be unique per shop
  @@unique([code, siteId])
  
  // Indexes for performance
  @@index([siteId, referrerId]) // Shop + referrer queries
  @@index([siteId])             // Shop-specific queries
}

// ReferralDiscountCode: One-time use Shopify discount codes for security
// Created when someone clicks a referral link (e.g., "GACHI-ALICE123-XK7N")
// Prevents coupon code scraping and abuse
// Previously named: ReferralSafeLink
model ReferralDiscountCode {
  id             Int @id @default(autoincrement())
  oneTimeCode    String @unique  // Unique token for tracking: "ALICE123-ABC123XYZ" (includes timestamp)
  referralCodeId Int  // Links to parent ReferralCode
  referralCode   ReferralCode @relation(fields:[referralCodeId], references:[id], onDelete: Cascade)
  
  // The actual Shopify discount code
  code           String?  // Unique discount code: "GACHI-ALICE123-ABC1"
  shopifyDiscountId String?  // Full Shopify GID: "gid://shopify/DiscountCodeNode/123"
  
  // Usage tracking
  used           Boolean @default(false)  // Has this discount been used?
  usedAt         DateTime?  // When was it used?
  usedByOrderId  String?  // Full Shopify GID: "gid://shopify/Order/123" (if used)
  
  // Expiry management
  createdAt      DateTime @default(now())
  expiresAt      DateTime?  // When does this discount expire? (default: 7 days from creation)
  
  // Indexes for performance and cleanup
  @@index([oneTimeCode])           // Fast lookup by one-time code
  @@index([used])                  // Find unused discounts
  @@index([expiresAt])             // Cleanup expired discounts
  @@index([used, expiresAt])       // Find unused expired discounts for cleanup
  @@index([referralCodeId])        // Discounts by referral code
  @@index([code])                  // Lookup by discount code
}

// ReferralJoin: Tracks when a referral results in a purchase
// Created when webhook detects order with referral discount
// ENHANCED: Includes direct referrer relationship for easier queries
model ReferralJoin {
  id        Int @id @default(autoincrement())
  
  // Referral relationship (via referral code)
  referralCodeId Int  // Which referral code was used
  referralCode   ReferralCode @relation(fields:[referralCodeId], references:[id], onDelete: Cascade)
  
  // Direct referrer link (for easier queries and better performance)
  // This is the StorefrontUser who did the referring
  referrerId Int  // Direct link to referrer
  referrer StorefrontUser @relation("ReferrerToReferee", fields:[referrerId], references:[id])
  
  // Referee (person who was referred) information
  refereeShopifyCustomerId String?  // Full Shopify GID: "gid://shopify/Customer/456" (optional - guest orders)
  refereeEmail String  // Referee email (always available, used for self-referral prevention)
  
  // Shop and order information
  siteId    String  // Shop domain for multi-tenant isolation
  orderId   String  // Full Shopify GID: "gid://shopify/Order/123456789" (globally unique)
  orderNumber String?  // Human-readable order number: "1001"
  
  // Discount and financial information
  discountCode String?  // The discount code that was applied: "GACHI-ALICE123-XK7N"
  discountAmount Float?  // Amount of discount applied (in shop currency)
  orderTotal Float  // Total order value (in shop currency)
  
  // Status tracking
  status    String @default("pending")  // pending, verified, paid, cancelled
  createdAt DateTime @default(now())
  verifiedAt DateTime?  // When was this referral verified?
  
  // Unique constraint: Order IDs are globally unique, prevent duplicate tracking
  @@unique([orderId])
  
  // Indexes for performance and analytics
  @@index([orderId])                    // Fast order lookup
  @@index([siteId, referralCodeId])     // Shop referral reports
  @@index([status])                     // Status queries (pending, verified, etc.)
  @@index([refereeEmail, siteId])       // Customer lookup
  @@index([siteId, createdAt])          // Shop analytics (time-based queries)
  @@index([referralCodeId, createdAt])  // Referral performance over time
  @@index([referrerId])    // Direct referrer queries (who referred whom)
}

// ReferralConfig: Per-shop configuration settings
// One record per shop, stores referral program settings
model ReferralConfig {
  id           Int @id @default(autoincrement())
  siteId       String @unique  // Shop domain: "store.myshopify.com" (one config per shop)
  
  // Program status
  enabled      Boolean @default(true)  // Is the referral program enabled for this shop?
  
  // Reward configuration (stored as JSON for flexibility)
  giveReward   String?  // JSON: { "type": "percent", "value": 10 } - What referrer gets
  getReward    String?  // JSON: { "type": "percent", "value": 10 } - What referee gets
  
  // Discount settings
  type         String? @default("percentage")  // "percentage" or "fixed_amount"
  amount       Float? @default(10.0)  // Discount percentage (10 = 10%) or fixed amount
  minimumSpend Float?  // Minimum order value to use discount (optional)
  
  // Program limits
  maxReferrals Int?  // Maximum referrals per customer (optional, null = unlimited)
  
  // Discount code settings
  discountCodeExpiryHours Int @default(168)  // Discount code expiry in hours (default: 7 days = 168 hours)
  
  // Timestamps
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt  // Auto-updated on changes
}

// WebhookQueue: Queue for processing webhooks asynchronously
// Ensures fast response to Shopify (< 5 seconds) while processing can take longer
model WebhookQueue {
  id        Int @id @default(autoincrement())
  topic     String  // Webhook topic: "orders/create", "app/uninstalled", etc.
  siteId    String  // Shop domain: "store.myshopify.com"
  payload   String  // JSON string of webhook payload
  status    String  @default("pending")  // pending, processing, completed, failed
  attempts  Int     @default(0)  // Number of processing attempts
  error     String?  // Error message if processing failed
  processedAt DateTime?  // When processing completed
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Indexes for performance
  @@index([status, createdAt])  // Find pending webhooks to process
  @@index([siteId, topic])        // Shop-specific queries
  @@index([status])             // Status queries
}
